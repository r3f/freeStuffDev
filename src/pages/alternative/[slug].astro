---
import { getCollection } from 'astro:content'
import Layout from '../../layouts/Layout.astro'
import Header from '../../components/Header.astro'
import Card from '../../components/Card.astro'
import Sponsors from '../../components/Sponsors.astro'

export async function getStaticPaths() {
    const tools = await getCollection('tools')
    return tools.map((tool) => {
        return {
            params: {
                slug: tool.slug
            },
            props: {
                tool
            }
        }
    })
}

const tool = Astro.props.tool
const year = new Date().getFullYear()

const relatedTags = tool.data.tags.map((tag: string) => {
    return tag
})

let groupedTools = {} as any
for(let i = 0; i < relatedTags.length; i++) {
    // è­¦å‘Šï¼šä¸è¦åœ¨æ­¤å¤„å°†æ ‡ç­¾å°å†™
    const tag = relatedTags[i].trim()
    const tools = await getCollection('tools', ({ data }) => {
        return data.tags.includes(tag)
    })

    // ä»åˆ—è¡¨ä¸­ç§»é™¤å½“å‰å·¥å…·
    const index = tools.findIndex((t) => t.slug === tool.slug)
    if (index > -1) {
        tools.splice(index, 1)
    }

    if (tools.length === 0) {
        continue
    }

    groupedTools[tag] = tools   
}

let tagsInString = relatedTags.join(', ')
tagsInString = tagsInString.replace(/,([^,]*)$/, ' å’Œ$1')

const toolTitle = tool.data.title
const title = `ä¸ºå¼€å‘è€…æŸ¥æ‰¾ ${toolTitle} çš„å…è´¹æ›¿ä»£å“ - ${year} - AAFREE`
const description = `ä¸ºå¼€å‘è€…æä¾›çš„ ${toolTitle} å…è´¹æ›¿ä»£å“åˆ—è¡¨ã€‚æ ¹æ®æ‚¨çš„éœ€æ±‚ï¼ŒæŸ¥æ‰¾ ${tool.data.title} ä½œä¸º ${tagsInString} å·¥å…·çš„æœ€ä½³æ›¿ä»£å“ã€‚`
---

<Layout
    title={title}
    description={description}
    >

    <Header
        title={title}
        description={description}
        />

    <Card tool={tool} />

    <div class="mt-10">
    {Object.keys(groupedTools).map((tag) => {
        return (
            <div>
                <h3 class="text-xl mb-5 text-sky-200">ğŸ‘‰ {toolTitle} ä½œä¸º {tag} å·¥å…·/æœåŠ¡çš„æ›¿ä»£å“</h3>
                <div class="grid grid-cols-1 gap-4">
                    {groupedTools[tag].map((tool: any) => {
                        return (
                            <Card tool={tool} />
                        )
                    })}
                </div>
            </div>
        )
    })}
    </div>

    <Sponsors />

</Layout>